<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Tr√¨nh ƒë·ªçc s√°ch n√¢ng cao</title>
  <style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f4f4f4;
    color: #000;
    transition: background 0.3s, color 0.3s;
  }
  header {
    background: #333;
    color: #fff;
    padding: 10px;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }
  header input, header button {
    padding: 5px 8px;
    cursor: pointer;
  }
  #viewer {
    width: 100%;
    height: calc(100vh - 60px);
    overflow: auto;
    padding: 10px;
    background: #fff;
    transition: background 0.3s, color 0.3s;
  }
  canvas {
    display: block;
    margin: 0 auto 20px auto;
    box-shadow: 0 0 6px rgba(0,0,0,0.3);
  }

  /* üåô Dark mode */
  body.dark {
    background: #121212;
    color: #eee;
  }
  body.dark header {
    background: #222;
    color: #fff;
  }
  body.dark #viewer {
    background: #1e1e1e;
    color: #ddd;
  }
</style>

</head>
<body>
  <header>
    <input type="file" id="fileInput" />
    <button onclick="toggleTheme()">üåô/‚òÄÔ∏è</button>
    <button onclick="zoomIn()">Zoom +</button>
    <button onclick="zoomOut()">Zoom -</button>
    <button onclick="toggleScrollMode()">Ch·∫ø ƒë·ªô: <span id="scrollMode">Trang ƒë∆°n</span></button>
    <span id="pageInfo">Trang: -/-</span>
    <input type="number" id="pageInput" placeholder="S·ªë trang" style="width:70px">
    <button onclick="goToPage()">ƒêi</button>
  </header>

  <div id="viewer"></div>

  <!-- Th∆∞ vi·ªán PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <!-- Th∆∞ vi·ªán EPUB.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/epub.js/0.3.88/epub.min.js"></script>

  <script>
    let pdfDoc = null, pageNum = 1, scale = 1.0;
    let viewer = document.getElementById("viewer");
    let themeDark = false;
    let scrollMode = false;
    let currentFileName = null;

    document.getElementById("fileInput").addEventListener("change", handleFile);

    function handleFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);

      currentFileName = file.name;
      viewer.innerHTML = "";
      pdfDoc = null;

      if (file.type === "application/pdf") {
        renderPDF(url);
      } else if (file.name.endsWith(".epub")) {
        renderEPUB(url);
      } else if (file.type.startsWith("text")) {
        renderTXT(file);
      } else {
        alert("ƒê·ªãnh d·∫°ng ch∆∞a h·ªó tr·ª£!");
      }
    }

    // ===== PDF =====
    async function renderPDF(url) {
      pdfDoc = await pdfjsLib.getDocument(url).promise;
      
      // ki·ªÉm tra c√≥ l∆∞u trang kh√¥ng
      const savedPage = localStorage.getItem("page_" + currentFileName);
      pageNum = savedPage ? parseInt(savedPage) : 1;

      updatePageInfo();
      renderPage(pageNum);
    }

    async function renderPage(num) {
      if (!pdfDoc) return;

      if (scrollMode) {
        viewer.innerHTML = "";
        for (let i = 1; i <= pdfDoc.numPages; i++) {
          const page = await pdfDoc.getPage(i);
          const viewport = page.getViewport({ scale: scale });
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          viewer.appendChild(canvas);
          await page.render({ canvasContext: ctx, viewport: viewport }).promise;
        }
      } else {
        const page = await pdfDoc.getPage(num);
        const viewport = page.getViewport({ scale: scale });
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        viewer.innerHTML = "";
        viewer.appendChild(canvas);
        await page.render({ canvasContext: ctx, viewport: viewport }).promise;

        // l∆∞u trang hi·ªán t·∫°i
        if (currentFileName) {
          localStorage.setItem("page_" + currentFileName, pageNum);
        }
      }
      updatePageInfo();
    }

    function zoomIn() { scale += 0.2; renderPage(pageNum); }
    function zoomOut() { scale = Math.max(0.5, scale - 0.2); renderPage(pageNum); }

    function updatePageInfo() {
      if (pdfDoc) {
        document.getElementById("pageInfo").textContent = `Trang: ${pageNum}/${pdfDoc.numPages}`;
      }
    }

    function goToPage() {
      if (pdfDoc) {
        const input = document.getElementById("pageInput").value;
        const target = parseInt(input);
        if (target >= 1 && target <= pdfDoc.numPages) {
          pageNum = target;
          renderPage(pageNum);
        }
      }
    }

    function toggleScrollMode() {
      scrollMode = !scrollMode;
      document.getElementById("scrollMode").textContent = scrollMode ? "Cu·ªôn" : "Trang ƒë∆°n";
      renderPage(pageNum);
    }

    // ===== EPUB =====
    function renderEPUB(url) {
      const book = ePub(url);
      const rendition = book.renderTo(viewer, { width: "100%", height: "100%" });
      rendition.display();

      // l∆∞u v·ªã tr√≠ ƒë·ªçc EPUB
      const savedLoc = localStorage.getItem("epub_" + currentFileName);
      if (savedLoc) {
        rendition.display(savedLoc);
      }

      rendition.on("relocated", function(location){
        localStorage.setItem("epub_" + currentFileName, location.start.cfi);
      });
    }

    // ===== TXT =====
    function renderTXT(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        viewer.textContent = e.target.result;
      };
      reader.readAsText(file);
    }

    // ===== Theme Toggle =====
    function toggleTheme() {
      themeDark = !themeDark;
      document.body.classList.toggle("dark", themeDark);
      viewer.classList.toggle("dark", themeDark);
    }
  </script>
</body>
</html>
